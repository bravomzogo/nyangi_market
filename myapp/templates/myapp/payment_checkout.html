{% extends 'myapp/base.html' %}
{% load static %}
{% load humanize %}
{% load myapp_filters %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>Payment Details</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h4>Payment Instructions</h4>
                        <p>Please follow these steps to complete your payment:</p>
                        <ol>
                            <li>Choose your preferred payment method from the seller's payment options below</li>
                            <li>Send the total amount using the provided payment details</li>
                            <li>Take a screenshot or save the payment confirmation</li>
                            <li>Upload the proof of payment below</li>
                            <li>Wait for admin approval</li>
                            <li>Receive your receipt via email</li>
                        </ol>
                    </div>

                    <div class="payment-details mt-4">
                        <h4>Payment Information</h4>
                        {% if sellers_payment_info %}
                            {% for seller_info in sellers_payment_info %}
                            <div class="seller-payment-info mb-4 p-3 border rounded">
                                <h5 class="text-primary">{{ seller_info.shop_name }}</h5>
                                
                                {% if seller_info.mobile_money %}
                                <div class="payment-option mb-3">
                                    <h6><i class="fas fa-mobile-alt me-2"></i>Mobile Money Payment</h6>
                                    <div class="lipa-number-box">
                                        <h3 class="text-center text-success">{{ seller_info.mobile_money }}</h3>
                                        <p class="text-center text-muted">Send payment to this number</p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if seller_info.bank_name and seller_info.account_number %}
                                <div class="payment-option mb-3">
                                    <h6><i class="fas fa-university me-2"></i>Bank Transfer</h6>
                                    <div class="bank-details p-3 bg-light rounded">
                                        <p><strong>Bank:</strong> {{ seller_info.bank_name }}</p>
                                        <p><strong>Account Number:</strong> {{ seller_info.account_number }}</p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if not seller_info.mobile_money and not seller_info.bank_name %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Payment details not available for this seller. Please contact seller directly.
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback to static LIPA number if no seller payment info -->
                            <div class="lipa-number-box">
                                <h2 class="text-center">{{ lipa_number }}</h2>
                            </div>
                        {% endif %}
                        
                        <h4 class="mt-4">Order Summary</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr>
                                    <td>{{ item.product.name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.product.price|intcomma }} Tsh</td>
                                    <td>{{ item.product.price|multiply:item.quantity|intcomma }} Tsh</td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td colspan="3" class="text-right"><strong>Total Amount:</strong></td>
                                    <td><strong>{{ total_amount|intcomma }} Tsh</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <form method="POST" action="{% url 'submit_payment_proof' %}" enctype="multipart/form-data" class="mt-4">
                            {% csrf_token %}
                            <input type="hidden" name="order_id" value="{{ order.id }}">
                            {% if sellers_payment_info %}
                                {% for seller_info in sellers_payment_info %}
                                    <input type="hidden" name="seller_{{ forloop.counter }}_mobile_money" value="{{ seller_info.mobile_money }}">
                                    <input type="hidden" name="seller_{{ forloop.counter }}_bank" value="{{ seller_info.bank_name }}">
                                    <input type="hidden" name="seller_{{ forloop.counter }}_account" value="{{ seller_info.account_number }}">
                                {% endfor %}
                            {% else %}
                                <input type="hidden" name="lipa_number" value="{{ lipa_number }}">
                            {% endif %}
                            
                            <div class="form-group">
                                <label for="reference_number">Payment Reference Number (Optional)</label>
                                <input type="text" class="form-control" id="reference_number" name="reference_number">
                                <small class="form-text text-muted">Enter the reference number from your payment confirmation (if available)</small>
                            </div>

                            <div class="form-group mt-3">
                                <label for="payment_proof">Upload Payment Proof</label>
                                <input type="file" class="form-control" id="payment_proof" name="payment_proof" required>
                                <small class="form-text text-muted">Upload a screenshot or photo of your payment confirmation</small>
                            </div>

                            <button type="submit" class="btn btn-primary mt-3">Submit Payment Proof</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Need Help?</h4>
                </div>
                <div class="card-body">
                    <p>If you need assistance with your payment, please contact our support team:</p>
                    <ul class="list-unstyled">
                        <li>
                            <a href="https://wa.me/255761434077" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                <i class="fab fa-whatsapp" style="color:#25D366;"></i>
                                <span class="ms-2">+255 761 434 077</span>
                            </a>
                        </li>
                        <li><i class="fas fa-envelope"></i> support@nyangimarketplace.co.tz</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.seller-payment-info {
    background: #f8f9fa;
    border: 1px solid #e9ecef !important;
}

.seller-payment-info h5 {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}

.payment-option {
    background: white;
    border-radius: 8px;
    padding: 15px;
}

.lipa-number-box {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 10px 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.bank-details {
    border-left: 4px solid #007bff;
}

.bank-details p {
    margin-bottom: 8px;
}

.bank-details p:last-child {
    margin-bottom: 0;
}
</style>
{% endblock %}
