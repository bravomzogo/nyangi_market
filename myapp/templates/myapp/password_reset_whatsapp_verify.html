{% extends 'myapp/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    <h3>Enter Verification Code</h3>
                </div>
                <div class="card-body">
                    <p class="text-center mb-4">We've sent a verification code to your WhatsApp number. Please enter it below.</p>
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="form-group mb-4">
                            <label for="verification_code">Verification Code</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-shield-lock"></i></span>
                                <input type="text" class="form-control" id="verification_code" name="verification_code" placeholder="Enter 6-digit code" required maxlength="6">
                            </div>
                            <small class="form-text text-muted">
                                Enter the 6-digit code sent to your WhatsApp
                            </small>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Verify Code
                            </button>
                        </div>
                    </form>
                    
                    <div class="text-center mt-3">
                        <p>Didn't receive a code? <a href="#" id="resendCode" class="text-decoration-none">Resend Code</a></p>
                        <div id="resendTimer" class="text-muted small d-none">
                            Resend available in <span id="timer">60</span> seconds
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const resendLink = document.getElementById('resendCode');
        const resendTimer = document.getElementById('resendTimer');
        const timerSpan = document.getElementById('timer');
        
        let seconds = 60;
        let countdown;
        
        resendLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Send AJAX request to resend code
            fetch("{% url 'resend_whatsapp_code' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone_number: '{{ phone_number }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Hide resend link and show timer
                    resendLink.classList.add('d-none');
                    resendTimer.classList.remove('d-none');
                    
                    // Start countdown
                    seconds = 60;
                    countdown = setInterval(function() {
                        seconds--;
                        timerSpan.textContent = seconds;
                        
                        if(seconds <= 0) {
                            clearInterval(countdown);
                            resendLink.classList.remove('d-none');
                            resendTimer.classList.add('d-none');
                        }
                    }, 1000);
                } else {
                    alert('Failed to resend code. Please try again later.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again later.');
            });
        });
    });
</script>

<style>
    .card {
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    #verification_code {
        letter-spacing: 0.5em;
        font-size: 1.2rem;
        text-align: center;
    }
</style>
{% endblock %}
